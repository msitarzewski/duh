# 160216_cli-app

## Objective
Implement Task 22: CLI app — Click commands (ask, recall, threads, show, models, cost) with tests for argument parsing, output formatting, and error display.

## Outcome
- 649 tests passing (+30 new)
- ruff clean
- mypy strict clean (24 source files)

## Files Modified
- `src/duh/cli/app.py` — Rewrote from stub to full 6-command CLI app
- `tests/unit/test_cli.py` — 30 tests via Click CliRunner

## CLI Commands

### `duh ask "question" [--rounds N]`
- Loads config, sets up providers, runs full consensus loop (PROPOSE/CHALLENGE/REVISE/COMMIT)
- Displays decision, confidence percentage, cost in USD, and dissent (if any)
- `--rounds` flag overrides `general.max_rounds` from config

### `duh recall "query" [--limit N]`
- Keyword search across thread questions and decision content
- Shows thread ID prefix, question, latest decision snippet, confidence
- Eagerly loads decisions via `session.refresh()` to avoid lazy-load after session close

### `duh threads [--status active|complete|failed] [--limit N]`
- Lists past consensus threads ordered by most recent
- Shows ID prefix, status, creation date, question snippet

### `duh show <thread_id>`
- Displays full debate history: question, status, all rounds with contributions
- Shows decision confidence, content, and dissent per round
- Supports UUID prefix matching (minimum 8 chars)

### `duh models`
- Lists all configured providers and their available models
- Shows display name, model ID, context window, input/output pricing

### `duh cost`
- Aggregates cost from stored contributions in the database
- Shows total cost, total tokens (input + output), breakdown by model

## Architecture Decisions
- Async wrappers: each command is sync Click function calling `asyncio.run()` on async implementation
- `_create_db()` returns `(async_sessionmaker, AsyncEngine)` — creates tables on first use
- `_setup_providers()` instantiates providers from config, skips those without API keys
- `_run_consensus()` orchestrates full state machine loop — extracted for testability
- `_error()` prints to stderr and exits with code 1
- Pre-existing protocol mismatch on provider `stream()` → `type: ignore[arg-type]` on register calls

## Testing Strategy
- Click `CliRunner` for all tests — invokes commands in-process
- `patch("duh.cli.app.asyncio.run")` for unit tests — returns canned tuples
- `StaticPool` + `AsyncMock` for DB integration — in-memory SQLite with shared connection
- `_make_db()` helper creates engine/sessionmaker synchronously, seeds via `asyncio.run()`
- `_setup_providers` patched with `side_effect` for models command tests

## Patterns Applied
- Extends `src/duh/cli/app.py` (existing scaffold)
- Reuses `load_config()` from `duh.config.loader`
- Reuses `ProviderManager` from `duh.providers.manager`
- Reuses `MemoryRepository` from `duh.memory.repository`
- DB integration tests mirror `tests/conftest.py:db_session` pattern (StaticPool, FK pragma)
