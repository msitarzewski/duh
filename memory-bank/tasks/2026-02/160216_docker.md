# 160216_docker

## Objective
Implement Task 24: Docker — Dockerfile improvements, docker-compose, volume mounts. Also fixed a bug where providers weren't auto-discovered from environment variables.

## Outcome
- 681 tests passing (no new tests — infrastructure task)
- ruff clean
- mypy strict clean (25 source files)
- Bug fix: providers now auto-discovered from env vars without config file

## Files Created
- `docker-compose.yml` — single service with named volume, env var passthrough
- `docker/config.toml` — container config with DB at `/data/duh.db`, provider env var refs
- `.dockerignore` — excludes .venv, .git, tests, results, memory-bank, phase0

## Files Modified
- `Dockerfile` — added OCI labels, `mkdir /data` with ownership, copy container config, set `DUH_CONFIG`, removed unused `DUH_DATA_DIR`
- `src/duh/config/schema.py` — default providers now include anthropic/openai with `api_key_env`
- `tests/unit/test_config.py` — updated 2 assertions for new provider defaults

## Bug Fix: Provider Auto-Discovery
**Problem**: `duh ask "question"` with `ANTHROPIC_API_KEY` in env returned "No models available" because `DuhConfig.providers` defaulted to empty dict — `_resolve_api_keys()` had nothing to resolve.

**Fix**: Changed `providers` default from `{}` to include anthropic and openai entries with `api_key_env` set. Now `_resolve_api_keys()` finds the env var references and resolves them automatically.

**Flow**: `DuhConfig()` → providers have `api_key_env` → `_resolve_api_keys()` reads env vars → `_setup_providers()` creates adapters for providers with keys.

## Docker Architecture
- Multi-stage build: builder (uv sync) → runtime (python:3.11-slim)
- Non-root `duh` user (UID 1000)
- `/data` volume for SQLite persistence
- `DUH_CONFIG=/app/config.toml` points to container-specific config
- API keys passed via environment variables

## Usage
```bash
# Direct
docker build -t duh .
docker run -v duh-data:/data -e ANTHROPIC_API_KEY duh ask "question"

# Compose
docker compose run duh ask "question"
docker compose run duh recall "topic"
```

## Patterns Applied
- Extended existing `Dockerfile` (Task 1 scaffold)
- Container config overrides DB path for volume mount
- `DUH_CONFIG` env var (existing feature from `config/loader.py`) used for container config injection
