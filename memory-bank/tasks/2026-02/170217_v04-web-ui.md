# 170217_v04-web-ui

## Objective
Implement v0.4.0 "It Has a Face" — a React frontend embedded in FastAPI with a flagship 3D Decision Space visualization, real-time WebSocket consensus streaming, thread browser, and preferences.

## Outcome
- 0 TypeScript errors, clean build (660 modules, 3.1s)
- 1318 Python tests passing (all existing + version bump)
- Frontend build: 277KB main JS + 873KB lazy Three.js chunk (code-split)
- Version bumped to 0.4.0 across pyproject.toml, __init__.py, api/app.py

## Files Created (Frontend — web/)

### Config
- `web/package.json` — React 19, Vite 6, Tailwind 4, Three.js, Zustand 5, Vitest 3
- `web/tsconfig.json` — strict TS with `@/*` path alias
- `web/vite.config.ts` — proxy /api and /ws to :8080, @/ alias, Tailwind plugin
- `web/index.html` — entry with Inter + JetBrains Mono fonts

### Theme (web/src/theme/)
- `duh-theme.css` — CSS custom properties (colors, glass, typography, transitions)
- `animations.css` — 9 keyframes (pulse-glow, fade-in-up, cursor-blink, data-flow, etc.)

### API Client (web/src/api/)
- `types.ts` — All TS interfaces matching backend Pydantic models + WS event union
- `client.ts` — Typed fetch client for all 8+2 REST endpoints
- `websocket.ts` — ConsensusWebSocket class with event callbacks
- `index.ts` — barrel exports

### Stores (web/src/stores/)
- `consensus.ts` — WebSocket-driven state machine (status, phases, rounds, result)
- `threads.ts` — list, detail, search, pagination, feedback
- `decision-space.ts` — decisions, filters, hover/select, timeline playback
- `preferences.ts` — localStorage-persisted via zustand/persist
- `index.ts` — barrel exports

### Shared Components (web/src/components/shared/)
- `GlassPanel.tsx` — glassmorphism container (3 variants, glow, padding)
- `GlowButton.tsx` — button with glow effects (primary/ghost/danger)
- `Badge.tsx` — status badge (5 color variants)
- `Skeleton.tsx` — loading placeholder
- `ErrorBoundary.tsx` — React error boundary with sci-fi fallback
- `GridOverlay.tsx` — SVG circuit-board grid background
- `ParticleField.tsx` — canvas floating particles

### Layout (web/src/components/layout/)
- `Shell.tsx` — root layout with sidebar + content + GridOverlay + ParticleField
- `Sidebar.tsx` — glass nav with 4 NavLinks, mobile close
- `TopBar.tsx` — hamburger toggle, health indicator (polls /api/health)

### Consensus (web/src/components/consensus/)
- `ConsensusPanel.tsx` — main orchestrator
- `QuestionInput.tsx` — textarea + rounds/protocol selectors
- `PhaseCard.tsx` — per-phase display with model badges
- `StreamingText.tsx` — character reveal with cursor
- `ConfidenceMeter.tsx` — SVG circular gauge (color by threshold)
- `DissentBanner.tsx` — amber-bordered dissent panel
- `ConsensusComplete.tsx` — final result with copy button
- `ModelBadge.tsx` — provider-colored badge
- `CostTicker.tsx` — running $ display

### Threads (web/src/components/threads/)
- `ThreadBrowser.tsx` — list with filters + search + pagination
- `ThreadCard.tsx` — clickable summary card
- `ThreadSearch.tsx` — debounced search input
- `ThreadFilters.tsx` — status filter pills
- `ThreadDetail.tsx` — full thread view with turns
- `TurnCard.tsx` — round with contributions + decision

### Decision Space (web/src/components/decision-space/)
- `DecisionSpace.tsx` — main component, 3D/2D switching via useMediaQuery
- `Scene3D.tsx` — lazy-loaded R3F Canvas (keeps Three.js out of main bundle on mobile)
- `DecisionCloud.tsx` — InstancedMesh point cloud (X=time, Y=category, Z=genus)
- `GridFloor.tsx` — dual grid helpers
- `FilterPanel.tsx` — category/genus/outcome filter toggles
- `TimelineSlider.tsx` — play/pause with speed control
- `ScatterFallback.tsx` — 2D SVG scatter for mobile

### Preferences (web/src/components/preferences/)
- `PreferencesPanel.tsx` — rounds slider, protocol radio, cost threshold, sound toggle

### Pages (web/src/pages/)
- `ConsensusPage.tsx`, `ThreadsPage.tsx`, `ThreadDetailPage.tsx`
- `DecisionSpacePage.tsx`, `PreferencesPage.tsx`, `SharePage.tsx`

### Other
- `web/src/hooks/useMediaQuery.ts` — responsive breakpoint hook
- `web/src/utils/colors.ts` — outcome colors, axis index helpers
- `web/src/three-types.d.ts` — R3F JSX type declarations

## Files Modified (Backend — src/duh/)

### src/duh/api/app.py
- Version bumped to 0.4.0
- Added `_mount_frontend()` — serves web/dist/ static files with SPA fallback
- Looks for dist/ relative to project root or /app/web/dist (Docker)

### src/duh/api/middleware.py
- Added `EXEMPT_PREFIXES` with `/api/share/`
- Added non-API path bypass (frontend static files skip auth)

### src/duh/api/routes/crud.py
- Added `GET /api/decisions/space` endpoint with filters (category, genus, outcome, confidence range, date range, search)
- 3 new Pydantic models: SpaceDecisionResponse, SpaceAxisMeta, DecisionSpaceResponse

### src/duh/api/routes/threads.py
- Added `GET /api/share/{share_token}` endpoint (no auth required)

### src/duh/memory/repository.py
- Added `get_all_decisions_for_space()` method with join/filter/eager loading

### src/duh/cli/app.py
- `duh serve` now logs "Web UI: http://host:port" when dist/ exists

### src/duh/__init__.py + pyproject.toml
- Version bumped 0.3.0 -> 0.4.0

### Dockerfile
- Added Node.js 22 frontend build stage
- Copies web/dist/ into runtime image
- Default CMD changed to `serve --host 0.0.0.0 --port 8080`
- Added EXPOSE 8080

### docker-compose.yml
- Added port mapping 8080:8080
- Added GOOGLE_API_KEY, MISTRAL_API_KEY env vars

### .gitignore + .dockerignore
- Added web/node_modules/, web/dist/

### tests/
- Updated version assertions: 0.3.0 -> 0.4.0 in test_smoke.py, test_cli.py

## Patterns Applied
- Lazy loading Three.js via React.lazy + dynamic import (Scene3D)
- Zustand with persist middleware for preferences
- CSS custom properties for design system tokens
- R3F InstancedMesh for performant point cloud rendering
- Path-prefix auth exemption pattern in middleware

## What Remains (Not Yet Implemented)
- T14: Animations + sound + polish (sound files, page transitions)
- T17: Vitest unit tests for frontend
- T18: Playwright E2E tests
- T19: Documentation (docs/web-ui.md, web-quickstart.md)
- T20: Hosted demo (try.duh.dev)
- T21: Final version verification
